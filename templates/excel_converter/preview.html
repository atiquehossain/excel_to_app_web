{% extends "base.html" %}
{% load custom_filters %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8">Code Preview</h1>
        
        <!-- App Info -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Generated App Details</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <p class="font-medium">App Name:</p>
                    <p class="text-gray-700">{{ app_name }}</p>
                </div>
                <div>
                    <p class="font-medium">Ideal Sheet:</p>
                    <p class="text-gray-700">{{ ideal_sheet }}</p>
                </div>
            </div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="border-b border-gray-200 mb-4">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button 
                        class="px-3 py-2 text-sm font-medium rounded-t-lg hover:bg-gray-100 bg-gray-100 border-b-2 border-blue-500"
                        onclick="showPreviewTab('models')"
                        id="models-tab"
                    >
                        Models
                    </button>
                    <button 
                        class="px-3 py-2 text-sm font-medium rounded-t-lg hover:bg-gray-100"
                        onclick="showPreviewTab('language-keys')"
                        id="language-keys-tab"
                    >
                        Language Keys
                    </button>
                    <button 
                        class="px-3 py-2 text-sm font-medium rounded-t-lg hover:bg-gray-100"
                        onclick="showPreviewTab('key-values')"
                        id="key-values-tab"
                    >
                        Key Values
                    </button>
                    <button 
                        class="px-3 py-2 text-sm font-medium rounded-t-lg hover:bg-gray-100"
                        onclick="showPreviewTab('setup-data')"
                        id="setup-data-tab"
                    >
                        Setup Data
                    </button>
                    <button 
                        class="px-3 py-2 text-sm font-medium rounded-t-lg hover:bg-gray-100"
                        onclick="showPreviewTab('ui-code')"
                        id="ui-code-tab"
                    >
                        UI Code
                    </button>
                </nav>
            </div>
            
            <!-- Models Tab Content -->
            <div id="models-content" class="tab-content">
                <div class="mb-4">
                    <h2 class="text-xl font-semibold">Generated Models</h2>
                </div>
                
                <!-- Model Files Navigation -->
                <div class="border-b border-gray-200 mb-4">
                    <nav class="flex space-x-4" aria-label="Model Tabs">
                        {% for file in generated_files %}
                        <button 
                            class="px-3 py-2 text-sm font-medium rounded-t-lg hover:bg-gray-100 
                                   {% if forloop.first %}bg-gray-100 border-b-2 border-blue-500{% endif %}"
                            onclick="showModelTab('{{ file.class_name }}')"
                        >
                            {{ file.sheet }}
                        </button>
                        {% endfor %}
                    </nav>
                </div>
                
                <!-- Model Code Content -->
                {% for file in generated_files %}
                <div id="model-{{ file.class_name }}" 
                     class="model-content {% if not forloop.first %}hidden{% endif %}">
                    <div class="bg-gray-800 rounded-lg p-4 overflow-x-auto">
                        <pre class="text-white"><code>{{ file.generated_code|default:"// Code will be generated here" }}</code></pre>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Language Keys Tab Content -->
            <div id="language-keys-content" class="tab-content hidden">
                <div class="mb-4">
                    <h2 class="text-xl font-semibold">Language Keys</h2>
                </div>
                <div class="bg-gray-800 rounded-lg p-4 overflow-x-auto">
                    <pre class="text-white"><code>abstract class Languages {
{% for file in generated_files %}
  // {{ file.sheet }} Questions
  {% if file.questions %}
    {% for question in file.questions %}
  String get {{ question.key }};  // {{ question.question }}
    {% endfor %}
  {% endif %}

  // {{ file.sheet }} Fields
  {% if file.fields %}
    {% for field in file.fields %}
  String get {{ field.key }};  // {{ field.field }}
    {% endfor %}
  {% endif %}
{% endfor %}
}</code></pre>
                </div>
            </div>
            
            <!-- Key Values Tab Content -->
            <div id="key-values-content" class="tab-content hidden">
                <div class="mb-4">
                    <h2 class="text-xl font-semibold">Key Value Pairs</h2>
                </div>
                <div class="bg-gray-800 rounded-lg p-4 overflow-x-auto">
                    <pre class="text-white"><code>abstract class Languages {
{% for file in generated_files %}
  // {{ file.sheet }} Questions
  {% if file.questions %}
    {% for question in file.questions %}
  String get {{ question.key }} => "{{ question.question }}";
    {% endfor %}
  {% endif %}

  // {{ file.sheet }} Fields
  {% if file.fields %}
    {% for field in file.fields %}
  String get {{ field.key }} => "{{ field.field }}";
    {% endfor %}
  {% endif %}

{% endfor %}
}</code></pre>
                </div>
            </div>
            
            <!-- Setup Data Tab Content -->
            <div id="setup-data-content" class="tab-content hidden">
                <div class="mb-4">
                    <h2 class="text-xl font-semibold">Setup Data</h2>
                </div>
                <div class="bg-gray-800 rounded-lg p-4 overflow-x-auto">
                    <pre class="text-white"><code>class SetupConstant {
{% for file in generated_files %}
  {% if file.questions %}
    {% for question in file.questions %}
      {% if question.field_type|lower == 'radio' or question.field_type|lower == 'dropdown' or question.field_type|lower == 'multiple choice' or question.field_type|lower == 'multiple-choice' or question.field_type|lower == 'multiplechoice' %}
  static const String {{ question.database }} = "{{ question.database }}";
      {% endif %}
    {% endfor %}
  {% endif %}
{% endfor %}
}

class SetupData {
  static List<SetupModel> _getData(
    BuildContext context,
    String modelName,
  ) {
    List<SetupModel> items = [];
    
{% for file in generated_files %}
  {% if file.questions %}
    {% for question in file.questions %}
      {% if question.field_type|lower == 'radio' or question.field_type|lower == 'dropdown' or question.field_type|lower == 'multiple choice' or question.field_type|lower == 'multiple-choice' or question.field_type|lower == 'multiplechoice' %}
    if (modelName == SetupConstant.{{ question.database }}) {
      {% for field in file.fields %}
        {% if field.database_value == question.database %}
      items.add(SetupModel(Languages.getText(context)!.{{ field.key }}, "{{ forloop.counter }}"));
        {% endif %}
      {% endfor %}
    }
      {% endif %}
    {% endfor %}
  {% endif %}
{% endfor %}
    
    return items;
  }
  
  static List<SetupModel> getDropDownItems(BuildContext context, String modelName) {
    return _getData(context, modelName);
  }
}</code></pre>
                </div>
            </div>
            
            <!-- UI Code Tab Content -->
            <div id="ui-code-content" class="tab-content hidden">
                <div class="mb-4">
                    <h2 class="text-xl font-semibold">UI Implementation</h2>
                </div>
                
                <!-- UI Files Navigation -->
                <div class="border-b border-gray-200 mb-4">
                    <nav class="flex space-x-4" aria-label="UI Tabs">
                        {% for file in generated_files %}
                        <button 
                            class="px-3 py-2 text-sm font-medium rounded-t-lg hover:bg-gray-100 
                                   {% if forloop.first %}bg-gray-100 border-b-2 border-blue-500{% endif %}"
                            onclick="showUITab('{{ file.class_name }}')"
                        >
                            {{ file.sheet }}
                        </button>
                        {% endfor %}
                    </nav>
                </div>
                
                <!-- UI Code Content -->
                {% for file in generated_files %}
                <div id="ui-{{ file.class_name }}" 
                     class="ui-content {% if not forloop.first %}hidden{% endif %}">
                    <div class="bg-gray-800 rounded-lg p-4 overflow-x-auto">
                        <pre class="text-white"><code>class {{ file.class_name }}UI extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
{% if file.questions %}
    {% for question in file.questions %}
        /// Number = {{ question.question_no|default:forloop.counter }}
       
        {{ file.class_name }}Data(
          number: {{ question.question_no|default:forloop.counter }},
          condition: numbers.contains({{ question.question_no|default:forloop.counter }}),
          widget: {{ file.class_name }}Widget(
            question: Languages.getText(context)!.{{ question.key }},
            fieldType: {% if question.field_type|lower == 'radio' %}AppConstant.FieldType_radio{% elif question.field_type|lower == 'dropdown' %}AppConstant.FieldType_dropdown{% elif question.field_type|lower == 'multiple choice' %}AppConstant.FieldType_multiple_choice{% elif question.field_type|lower == 'multiple-choice' %}AppConstant.FieldType_multiple_choice{% elif question.field_type|lower == 'multiplechoice' %}AppConstant.FieldType_multiple_choice{% elif question.field_type|lower == 'number' %}AppConstant.FieldType_NumberText{% elif question.field_type|lower == 'date' %}AppConstant.FieldType_date{% elif question.field_type|lower == 'datetime' %}AppConstant.FieldType_date{% elif question.field_type|lower == 'image' %}AppConstant.FieldType_Image{% elif question.field_type|lower == 'photo' %}AppConstant.FieldType_Image{% else %}AppConstant.FieldType_EditText{% endif %},
            {% if question.field_type == 'Number' %}keyboardType: TextInputType.number,{% endif %}
            field: {{ file.class_name|stringformat:"s"|lower }}.{{ question.database }},
            dataList: {% if question.field_type == 'Number' or question.field_type == 'Text' %}null {% else %}SetupData.getDropDownItems(context, SetupConstant.{{ question.database }}) {% endif %},
            onChanged: (value) {
              {{ file.class_name|stringformat:"s"|lower }}.{{ question.database }} = value;
            },
          ),
        ),
    {% endfor %}
{% endif %}
      ],
    );
  }
}</code></pre>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex justify-end space-x-4">
            <button onclick="window.history.back()" 
                    class="bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600">
                Back
            </button>
            <button onclick="downloadAll()" 
                    class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600">
                Download All Files
            </button>
        </div>
    </div>
</div>

<script>
function showPreviewTab(tabName) {
    // Hide all tab content
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Show selected tab content
    document.getElementById(`${tabName}-content`).classList.remove('hidden');
    
    // Update tab button styles
    document.querySelectorAll('nav button').forEach(button => {
        button.classList.remove('bg-gray-100', 'border-b-2', 'border-blue-500');
    });
    document.getElementById(`${tabName}-tab`).classList.add('bg-gray-100', 'border-b-2', 'border-blue-500');
}

function showModelTab(className) {
    // Hide all model content
    document.querySelectorAll('.model-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Show selected model content
    document.getElementById(`model-${className}`).classList.remove('hidden');
    
    // Update model tab button styles
    document.querySelectorAll('nav[aria-label="Model Tabs"] button').forEach(button => {
        button.classList.remove('bg-gray-100', 'border-b-2', 'border-blue-500');
    });
    event.currentTarget.classList.add('bg-gray-100', 'border-b-2', 'border-blue-500');
}

function downloadAll() {
    const files = {{ generated_files|safe }};
    const fileNames = files.map(f => f.class_name + '.dart');
    const url = `{% url 'excel_converter:download_all' %}?files=${encodeURIComponent(JSON.stringify(fileNames))}`;
    window.location.href = url;
}

function showUITab(className) {
    // Hide all UI content
    document.querySelectorAll('.ui-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Show selected UI content
    document.getElementById(`ui-${className}`).classList.remove('hidden');
    
    // Update UI tab button styles
    document.querySelectorAll('nav[aria-label="UI Tabs"] button').forEach(button => {
        button.classList.remove('bg-gray-100', 'border-b-2', 'border-blue-500');
    });
    event.currentTarget.classList.add('bg-gray-100', 'border-b-2', 'border-blue-500');
}
</script>
{% endblock %} 